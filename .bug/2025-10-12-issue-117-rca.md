# Bug Report — Missing xgboost and lightgbm Dependencies Break Ensemble Methods

## Summary
- **Scope/Area**: ml/ensemble, dependencies, tests
- **Type**: Missing Dependencies — Severity: S2 (High)
- **Environment**:
  - Branch: main
  - Commit: 115c65ae8db2dc827003e144c2e70a9143417ce0
  - OS: Darwin 24.5.0
  - Python: 3.11-3.12

## Expected vs Actual
- **Expected**: Ensemble ML methods (stacking, boosting) work correctly and tests pass
- **Actual**: Import fails with `ModuleNotFoundError: No module named 'xgboost'` and `No module named 'lightgbm'`

## Steps to Reproduce
1. `poetry run pytest src/alpha_pulse/tests/test_ensemble_methods.py`
2. Observe `ModuleNotFoundError` during test collection

## Evidence

### Missing Dependencies

**XGBoost:**
- **Used in**:
  - `src/alpha_pulse/ml/ensemble/stacking_methods.py:11` (`import xgboost as xgb`)
  - `src/alpha_pulse/ml/ensemble/boosting_algorithms.py:9` (`import xgboost as xgb`)
- **Status**: ❌ NOT in pyproject.toml
- **Poetry check**: `Package xgboost not found`

**LightGBM:**
- **Used in**:
  - `src/alpha_pulse/ml/ensemble/stacking_methods.py:12` (`import lightgbm as lgb`)
  - `src/alpha_pulse/ml/ensemble/boosting_algorithms.py:10` (`import lightgbm as lgb`)
- **Status**: ❌ NOT in pyproject.toml
- **Poetry check**: `Package lightgbm not found`

### Error Stack Trace
```
ERROR collecting src/alpha_pulse/tests/test_ensemble_methods.py
ImportError while importing test module
src/alpha_pulse/tests/test_ensemble_methods.py:17: in <module>
    from alpha_pulse.ml.ensemble.stacking_methods import (
src/alpha_pulse/ml/ensemble/stacking_methods.py:11: in <module>
    import xgboost as xgb
E   ModuleNotFoundError: No module named 'xgboost'
```

### Code Usage Analysis

**Stacking Methods (`stacking_methods.py`):**
- Line 11: `import xgboost as xgb`
- Line 12: `import lightgbm as lgb`
- Line 50-57: `XGBRegressor` used in meta-model creation
- Line 59-66: `LGBMRegressor` used in meta-model creation

**Boosting Algorithms (`boosting_algorithms.py`):**
- Line 9: `import xgboost as xgb`
- Line 10: `import lightgbm as lgb`
- Lines 401-567: `XGBoostEnsemble` class implementation
- Lines 660-804: `LightGBMEnsemble` class implementation

### Impact

**Affected Components:**
1. `StackingEnsemble` meta-model creation (xgboost, lightgbm options)
2. `XGBoostEnsemble` class (entire class unusable)
3. `LightGBMEnsemble` class (entire class unusable)
4. `OnlineBoosting` class (uses XGBoost as base model option)
5. All ensemble tests that import these modules

**Severity**: S2 (High)
- Major ML functionality broken
- Critical ensemble methods unavailable
- Tests completely failing
- Workaround exists: use sklearn-based ensembles (RandomForest, GradientBoosting)

## Diagnosis Timeline

### T0: Detection/Context (2025-10-11 17:41:14Z)
- Issue #117 opened: "Missing xgboost dependency for ensemble stacking methods"
- Reported: `ModuleNotFoundError: No module named 'xgboost'`

### T1: Investigation (2025-10-12)
- Verified imports in `stacking_methods.py` and `boosting_algorithms.py`
- Checked pyproject.toml: Neither xgboost nor lightgbm present
- Confirmed with `poetry show`: Both packages not installed
- Ran test: Fails at import time with ModuleNotFoundError

### T2: Scope Analysis (2025-10-12)
- Found xgboost used in 2 files (stacking_methods.py, boosting_algorithms.py)
- Found lightgbm also missing and used in same 2 files
- Identified 3 major classes broken: XGBoostEnsemble, LightGBMEnsemble, StackingEnsemble (partially)
- Test suite cannot even collect tests due to import failure

### T3: Root Cause Identified (2025-10-12)
- **Root Cause**: Required ML dependencies (xgboost, lightgbm) not declared in pyproject.toml
- **Code Impact**: Ensemble ML methods completely non-functional
- **Test Impact**: test_ensemble_methods.py cannot run

## Root Cause Analysis

### 5 Whys

1. **Why do the tests fail?**
   - Because Python cannot import xgboost and lightgbm modules

2. **Why can't Python import these modules?**
   - Because xgboost and lightgbm are not installed in the Poetry environment

3. **Why aren't they installed?**
   - Because they are not declared as dependencies in pyproject.toml

4. **Why weren't they declared?**
   - Possible reasons:
     a) Code was written assuming packages would be manually installed
     b) Dependencies were overlooked during refactoring
     c) Originally intended as optional dependencies but not properly gated
     d) Copied from another project where they were already installed globally

5. **Why wasn't this caught earlier?**
   - Tests may not be running in CI consistently
   - Developer environments may have had these packages installed globally
   - No dependency audit or import validation in CI pipeline

### Causal Chain

**ML Code Written** → **XGBoost/LightGBM Imports Added** → **Dependencies NOT Added to pyproject.toml** → **Poetry Install Doesn't Include Packages** → **Import Fails** → **Tests Fail** → **Ensemble Methods Broken**

### Change-Based Analysis

These are sophisticated ML ensemble methods that require specialized gradient boosting libraries. The code imports them unconditionally (no try/except), indicating they were considered required dependencies. However, they were never added to pyproject.toml, suggesting:
- The code may have been written in an environment where these were already installed
- Or there was incomplete dependency management during development
- No validation that all imports have corresponding dependency declarations

## Remediation

### Immediate Fix

Add both missing dependencies to pyproject.toml:

```toml
[tool.poetry.dependencies]
xgboost = "^2.0.0"
lightgbm = "^4.0.0"
```

Then run:
```bash
poetry add xgboost lightgbm
poetry install
```

### Alternative: Optional Dependencies (If Desired)

If these are meant to be optional, wrap imports with graceful degradation:

```python
# In stacking_methods.py and boosting_algorithms.py
try:
    import xgboost as xgb
    XGBOOST_AVAILABLE = True
except ImportError:
    XGBOOST_AVAILABLE = False
    xgb = None

try:
    import lightgbm as lgb
    LIGHTGBM_AVAILABLE = True
except ImportError:
    LIGHTGBM_AVAILABLE = False
    lgb = None

# Then in code:
def _create_meta_model(self) -> Any:
    if self.meta_model_type == 'xgboost':
        if not XGBOOST_AVAILABLE:
            raise ImportError("xgboost not installed. Install with: pip install xgboost")
        return xgb.XGBRegressor(...)
```

### Recommended Solution

**Add as required dependencies** because:
1. Multiple classes (`XGBoostEnsemble`, `LightGBMEnsemble`) are entirely dependent on them
2. Default configuration uses xgboost (`meta_model='xgboost'` in StackingEnsemble)
3. No fallback logic currently exists
4. Core ML functionality, not optional features

### Risk & Rollback Considerations

- **Risk**: Very Low - Adding standard ML dependencies
- **Package Size**:
  - xgboost: ~150MB
  - lightgbm: ~30MB
- **Compatibility**: Both work with Python 3.11-3.12
- **Rollback**: Simply remove from pyproject.toml if needed
- **Impact**: Fixes broken ensemble methods, unblocks tests

## Validation & Prevention

### Test Plan
1. ✅ Identify xgboost usage in codebase (found in 2 files)
2. ✅ Identify lightgbm usage in codebase (found in 2 files)
3. ⬜ Add xgboost to pyproject.toml
4. ⬜ Add lightgbm to pyproject.toml
5. ⬜ Run `poetry install`
6. ⬜ Verify imports work: `python -c "import xgboost, lightgbm"`
7. ⬜ Run ensemble tests: `poetry run pytest src/alpha_pulse/tests/test_ensemble_methods.py -v`
8. ⬜ Run full test suite to ensure no regressions

### Commands
```bash
# Add dependencies
poetry add xgboost lightgbm

# Verify installation
poetry show xgboost
poetry show lightgbm

# Test imports
PYTHONPATH=src poetry run python -c "import xgboost as xgb; import lightgbm as lgb; print('XGBoost:', xgb.__version__); print('LightGBM:', lgb.__version__)"

# Run tests
PYTHONPATH=src poetry run pytest src/alpha_pulse/tests/test_ensemble_methods.py -v
```

### Regression Prevention
- **Dependency Audit**: Add CI step to verify all imports have corresponding dependencies
- **Import Validation**: Create script to scan for imports and cross-reference with pyproject.toml
- **Pre-commit Hook**: Validate dependency completeness before commits
- **Documentation**: Document all ML dependencies and their purposes

### Example Validation Script
```python
# scripts/validate_dependencies.py
import ast
import sys
from pathlib import Path
import toml

def get_imports(file_path):
    with open(file_path) as f:
        tree = ast.parse(f.read())
    imports = set()
    for node in ast.walk(tree):
        if isinstance(node, ast.Import):
            for alias in node.names:
                imports.add(alias.name.split('.')[0])
        elif isinstance(node, ast.ImportFrom):
            if node.module:
                imports.add(node.module.split('.')[0])
    return imports

def get_declared_dependencies():
    pyproject = toml.load('pyproject.toml')
    return set(pyproject['tool']['poetry']['dependencies'].keys())

# Check all imports against dependencies
# Fail if any import doesn't have corresponding dependency
```

## Conclusion

This is a **GENUINE BUG** - two critical ML dependencies (xgboost, lightgbm) are used extensively in ensemble methods but not declared in pyproject.toml.

**Impact:**
- ❌ `XGBoostEnsemble` class: Completely broken
- ❌ `LightGBMEnsemble` class: Completely broken
- ❌ `StackingEnsemble` meta-models: Partially broken (xgboost/lightgbm options unavailable)
- ❌ `OnlineBoosting`: Partially broken (xgboost base model unavailable)
- ❌ All ensemble tests: Fail at import time

**Fix Required:**
```bash
poetry add xgboost lightgbm
```

## Ownership & Next Steps

- **Owner(s)**: Repository maintainers (blackms)
- **Priority**: High - Core ML functionality broken
- **Dependencies/links**:
  - Issue #117: https://github.com/blackms/AlphaPulse/issues/117
  - Files affected:
    - `src/alpha_pulse/ml/ensemble/stacking_methods.py`
    - `src/alpha_pulse/ml/ensemble/boosting_algorithms.py`
    - `src/alpha_pulse/tests/test_ensemble_methods.py`

### Checklist
- [x] Reproducible steps verified (Import error confirmed)
- [x] Evidence attached/linked (Import traces, file analysis)
- [x] RCA written and reviewed (5 Whys, causal chain complete)
- [ ] Dependencies added to pyproject.toml
- [ ] Tests passing
- [ ] Issue closed

---

**Generated**: 2025-10-12
**Analyzed by**: Claude Code (BUG-PROTO.yaml workflow)
**Status**: ANALYSIS COMPLETE - GENUINE MISSING DEPENDENCIES (Add xgboost + lightgbm)
