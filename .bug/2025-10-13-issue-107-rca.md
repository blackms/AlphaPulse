# Bug Report — Dataclass Field Ordering Error in OptimalExecutionParams

## Summary
- **Scope/Area**: models/slippage_estimates, dataclasses, Python syntax
- **Type**: Code Defect — Severity: S2 (High)
- **Environment**:
  - Branch: main
  - Commit: 2347b7c (after v1.21.2 release)
  - OS: Darwin 24.5.0
  - Python: 3.11-3.12

## Expected vs Actual
- **Expected**: `slippage_estimates.py` module imports successfully with properly ordered dataclass fields
- **Actual**: Import fails with `TypeError: non-default argument 'daily_volatility' follows default argument`

## Steps to Reproduce
1. `PYTHONPATH=src poetry run python -c "from alpha_pulse.models.slippage_estimates import OptimalExecutionParams"`
2. Observe `TypeError` during dataclass definition at line 336

## Evidence

### Error Stack Trace
```
TypeError: non-default argument 'daily_volatility' follows default argument
```

### Code Analysis

**File**: `src/alpha_pulse/models/slippage_estimates.py`
**Problematic Dataclass**: `OptimalExecutionParams` (lines 336-367)

**Issue**: Fields with defaults appear before fields without defaults

**Current Field Order (INCORRECT):**
```python
@dataclass
class OptimalExecutionParams:
    symbol: str                                    # ✅ Required
    order_size: float                              # ✅ Required

    # Almgren-Chriss parameters
    risk_aversion: float                           # ✅ Required
    temporary_impact_power: float = 1.0            # ⚠️ Has default
    permanent_impact_power: float = 0.5            # ⚠️ Has default

    # Constraints
    min_participation_rate: float = 0.01           # ⚠️ Has default
    max_participation_rate: float = 0.30           # ⚠️ Has default
    max_duration_minutes: float = 390              # ⚠️ Has default

    # Market parameters
    daily_volatility: float                        # ❌ Required AFTER defaults!
    daily_volume: float                            # ❌ Required AFTER defaults!
    bid_ask_spread: float                          # ❌ Required AFTER defaults!

    # Optimization results
    optimal_duration: Optional[float] = None       # ⚠️ Has default
    optimal_trajectory: Optional[np.ndarray] = None  # ⚠️ Has default
    expected_cost: Optional[float] = None          # ⚠️ Has default
    cost_variance: Optional[float] = None          # ⚠️ Has default
```

**Python Dataclass Rule Violation**:
- Fields `daily_volatility` (line 353), `daily_volume` (line 354), and `bid_ask_spread` (line 355) are **required** (no default)
- But they appear **after** fields with defaults (lines 344-350)
- This violates Python's dataclass ordering: **all fields without defaults must come before fields with defaults**

### Impact

**Affected Components:**
1. `OptimalExecutionParams` dataclass - Cannot be instantiated
2. Optimal execution algorithms that use this dataclass
3. Almgren-Chriss execution optimization
4. Any execution planning module that imports this
5. Tests that use optimal execution parameters

**Severity**: S2 (High)
- Entire slippage estimates module broken at import time
- Blocks optimal execution functionality
- Prevents execution planning features
- Tests cannot run due to import failure

## Diagnosis Timeline

### T0: Detection/Context (2025-10-11 17:36:53Z)
- Issue #107 opened: "Bug: OptimalExecutionParams dataclass ordering causes import failure"
- Reported: `TypeError: non-default argument 'daily_volatility' follows default argument`

### T1: Investigation (2025-10-13)
- Verified import failure in `slippage_estimates.py` line 336
- Identified `OptimalExecutionParams` dataclass as problematic
- Found 3 required fields (daily_volatility, daily_volume, bid_ask_spread) after 6 fields with defaults
- Confirmed violation of Python dataclass ordering rules

### T2: Scope Analysis (2025-10-13)
- Found error in `OptimalExecutionParams` class (lines 336-367)
- Identified 3 required fields after 6 optional fields
- Confirmed no other dataclasses in file have this issue:
  - ✅ `SlippageParameters` - All fields have defaults (correct)
  - ✅ `MarketImpactEstimate` - Correct ordering
  - ✅ `SlippageEstimate` - All required fields (correct)
  - ✅ `ExecutionPlan` - All required fields (correct)
  - ✅ `RealizedSlippage` - All required fields (correct)
  - ✅ `SlippageAnalysis` - All required fields (correct)
  - ❌ `OptimalExecutionParams` - **INCORRECT ORDERING**

### T3: Root Cause Identified (2025-10-13)
- **Root Cause**: Incorrect field ordering in `OptimalExecutionParams` dataclass
- **Code Impact**: Entire slippage_estimates module cannot be imported
- **Test Impact**: All execution/slippage tests fail at import time

## Root Cause Analysis

### 5 Whys

1. **Why does the slippage_estimates module fail to import?**
   - Because Python raises a TypeError when defining the `OptimalExecutionParams` dataclass

2. **Why does Python raise a TypeError?**
   - Because required fields (`daily_volatility`, `daily_volume`, `bid_ask_spread`) appear after fields with defaults

3. **Why are the fields ordered incorrectly?**
   - Possible reasons:
     a) Fields were added incrementally without checking dataclass ordering rules
     b) Logical grouping (market parameters) prioritized over Python syntax requirements
     c) Developer unfamiliar with Python dataclass field ordering requirements
     d) No validation or linting to catch dataclass ordering violations

4. **Why wasn't this caught in code review?**
   - No automated linting for dataclass field ordering
   - Manual review may not have caught subtle ordering issue
   - Tests may not have been run after adding these fields

5. **Why wasn't this caught in CI?**
   - Tests likely not covering this module import
   - CI may not be running import validation across all modules
   - No static analysis checking dataclass field ordering

### Causal Chain

**Feature Development** → **Fields Added to OptimalExecutionParams** → **Market Parameters Added After Constraint Defaults** → **Python Dataclass Validation Fails** → **Import Error** → **Optimal Execution Module Broken**

### Change-Based Analysis

The `OptimalExecutionParams` dataclass was likely built with logical grouping in mind:
1. Basic parameters (symbol, order_size, risk_aversion)
2. Almgren-Chriss parameters (with defaults for typical values)
3. Constraints (with defaults for reasonable limits)
4. Market parameters (required, vary by symbol/time)
5. Optimization results (optional, computed later)

This logical structure makes sense semantically, but violates Python's syntactic requirement that all non-default fields must precede fields with defaults.

## Remediation

### Immediate Fix

Reorder fields in `OptimalExecutionParams` to place all required fields before fields with defaults:

**Option 1: Move required fields up (Recommended)**
```python
@dataclass
class OptimalExecutionParams:
    """Parameters for optimal execution algorithms."""
    # Required fields (no defaults) - MUST COME FIRST
    symbol: str
    order_size: float
    risk_aversion: float

    # Market parameters (required) - MOVED UP
    daily_volatility: float
    daily_volume: float
    bid_ask_spread: float

    # Optional fields with defaults - MUST COME AFTER REQUIRED
    # Almgren-Chriss parameters
    temporary_impact_power: float = 1.0
    permanent_impact_power: float = 0.5

    # Constraints
    min_participation_rate: float = 0.01
    max_participation_rate: float = 0.30
    max_duration_minutes: float = 390

    # Optimization results
    optimal_duration: Optional[float] = None
    optimal_trajectory: Optional[np.ndarray] = None
    expected_cost: Optional[float] = None
    cost_variance: Optional[float] = None
```

**Option 2: Add defaults to all fields (Alternative)**
If market parameters can be optional:
```python
daily_volatility: Optional[float] = None
daily_volume: Optional[float] = None
bid_ask_spread: Optional[float] = None
```

### Recommended Solution

**Use Option 1 (reorder fields)** because:
1. Preserves the intent that market parameters are required
2. No breaking changes to API (all fields still present)
3. Fixes the Python syntax error
4. Market parameters are essential for optimal execution algorithms
5. Minimal code changes required

### Risk & Rollback Considerations

- **Risk**: Very Low - Field reordering with no API changes
- **Breaking Changes**: None - all fields remain with same types
- **Rollback**: Revert commit if issues arise
- **Impact**: Fixes broken import, unblocks optimal execution
- **Side Effects**: None - pure field reordering

## Validation & Prevention

### Test Plan
1. ✅ Identify incorrect field ordering in `OptimalExecutionParams`
2. ✅ Verify only `OptimalExecutionParams` has this issue
3. ⬜ Reorder fields: move required fields before optional fields
4. ⬜ Verify import works: `python -c "from alpha_pulse.models.slippage_estimates import OptimalExecutionParams"`
5. ⬜ Verify instantiation works with test data
6. ⬜ Run execution/slippage tests if available
7. ⬜ Run full test suite to ensure no regressions

### Commands
```bash
# Test import after fix
PYTHONPATH=src poetry run python -c "from alpha_pulse.models.slippage_estimates import OptimalExecutionParams; print('✅ Import successful')"

# Test instantiation
PYTHONPATH=src poetry run python -c "
from alpha_pulse.models.slippage_estimates import OptimalExecutionParams
params = OptimalExecutionParams(
    symbol='AAPL',
    order_size=1000,
    risk_aversion=0.5,
    daily_volatility=0.02,
    daily_volume=1000000,
    bid_ask_spread=0.01
)
print('✅ Instantiation successful')
print(f'Symbol: {params.symbol}, Risk aversion: {params.risk_aversion}')
"
```

### Regression Prevention
- **Linting**: Add ruff or mypy checks for dataclass field ordering
- **Pre-commit Hook**: Validate dataclass definitions
- **CI Check**: Add import validation for all modules
- **Code Review Checklist**: Include dataclass field ordering check
- **Documentation**: Add Python dataclass best practices to coding standards

## Conclusion

This is a **GENUINE BUG** - Python dataclass field ordering violation in `OptimalExecutionParams` class.

**Impact:**
- ❌ `OptimalExecutionParams` class: Cannot be defined (import-time error)
- ❌ Entire slippage_estimates module: Cannot be imported
- ❌ Optimal execution algorithms: Blocked
- ❌ Almgren-Chriss optimization: Blocked
- ❌ Execution planning tests: Cannot run

**Fix Required:**
Move `daily_volatility`, `daily_volume`, and `bid_ask_spread` fields before fields with defaults.

**Affected Lines:**
- Lines 344-350: Fields with defaults (temporary_impact_power through max_duration_minutes)
- Line 353: `daily_volatility` (required, NO default) ❌ MUST MOVE UP
- Line 354: `daily_volume` (required, NO default) ❌ MUST MOVE UP
- Line 355: `bid_ask_spread` (required, NO default) ❌ MUST MOVE UP

**Pattern**: Same issue as #116 (GlobalExplanation) - dataclass field ordering violation

## Ownership & Next Steps

- **Owner(s)**: Repository maintainers (blackms)
- **Priority**: High - Blocks optimal execution functionality
- **Dependencies/links**:
  - Issue #107: https://github.com/blackms/AlphaPulse/issues/107
  - Similar to #116: GlobalExplanation dataclass ordering (fixed in v1.21.2)
  - Files affected:
    - `src/alpha_pulse/models/slippage_estimates.py`

### Checklist
- [x] Reproducible steps verified (Import error confirmed)
- [x] Evidence attached/linked (Error trace, code analysis)
- [x] RCA written and reviewed (5 Whys, causal chain complete)
- [ ] Fields reordered in OptimalExecutionParams
- [ ] Import verified
- [ ] Tests passing
- [ ] Issue closed

---

**Generated**: 2025-10-13
**Analyzed by**: Claude Code (BUG-PROTO.yaml workflow)
**Status**: ANALYSIS COMPLETE - GENUINE DATACLASS ORDERING BUG (Reorder fields)
