# Bug Report — Dataclass Inheritance Field Ordering in Risk Scenarios

## Summary
- **Scope/Area**: models/risk_scenarios, dataclasses, Python inheritance
- **Type**: Code Defect — Severity: S2 (High)
- **Environment**:
  - Branch: main
  - Commit: ffef71e (after v1.21.3 release)
  - OS: Darwin 24.5.0
  - Python: 3.11-3.12

## Expected vs Actual
- **Expected**: `risk_scenarios.py` module imports successfully with properly ordered dataclass fields in inherited classes
- **Actual**: Import fails with `TypeError: non-default argument 'asset_returns' follows default argument` when child dataclasses define required fields after inheriting from parent with optional fields

## Steps to Reproduce
1. `PYTHONPATH=src poetry run pytest` (during test collection)
2. OR: `python -c "from alpha_pulse.models.risk_scenarios import MacroeconomicScenario"`
3. Observe `TypeError` during dataclass definition

## Evidence

### Error Stack Trace
```
TypeError: non-default argument 'asset_returns' follows default argument
```

### Code Analysis

**File**: `src/alpha_pulse/models/risk_scenarios.py`
**Problematic Dataclasses**: `MacroeconomicScenario`, `StressScenario`, `TailRiskScenario`

**Issue**: Child dataclasses with required fields inherit from parent class with optional fields

**Parent Class (CORRECT):**
```python
@dataclass
class Scenario:
    """Base class for all scenario types."""
    name: str
    scenario_type: ScenarioType
    probability: float
    time_horizon: float  # Years
    description: Optional[str] = None  # ⚠️ Has default
```

**Child Class (INCORRECT):**
```python
@dataclass
class MacroeconomicScenario(Scenario):
    """Macroeconomic scenario."""
    # Asset returns
    asset_returns: Dict[str, float]  # ❌ Required, NO default, AFTER parent's optional field

    # Macro variables
    gdp_shock: float  # ❌ Required, NO default
    inflation_shock: float  # ❌ Required, NO default
    interest_rate_shock: float  # ❌ Required, NO default
    unemployment_change: float  # ❌ Required, NO default

    # Financial conditions
    credit_spread_change: float  # ❌ Required, NO default
    term_spread_change: Optional[float] = None  # ✅ Has default

    # Currency impacts
    fx_changes: Optional[Dict[str, float]] = None  # ✅ Has default

    # Sector impacts
    sector_impacts: Optional[Dict[str, float]] = None  # ✅ Has default
```

**Python Dataclass Inheritance Rule Violation**:
- Parent class `Scenario` has optional field `description: Optional[str] = None` (line 109)
- Child class `MacroeconomicScenario` defines required fields without defaults (lines 155-164)
- In dataclass inheritance, **all fields from parent come first**, so child cannot have required fields after parent's optional fields
- This violates Python's dataclass ordering: **all fields without defaults must come before fields with defaults**

**Affected Classes:**
1. ❌ `MacroeconomicScenario` (lines 152-181) - 6 required fields after parent's optional field
2. ❌ `StressScenario` (lines 185-226) - 4 required fields after parent's optional field
3. ❌ `TailRiskScenario` (lines 230-252) - 3 required fields after parent's optional field
4. ✅ `MarketScenario` (lines 123-148) - **CORRECT** - All fields have defaults using `field(default_factory=...)`
5. ✅ `ReverseStressScenario` (lines 256-272) - **CORRECT** - All fields have no defaults (before parent's optional)

### Impact

**Affected Components:**
1. `MacroeconomicScenario` dataclass - Cannot be instantiated
2. `StressScenario` dataclass - Cannot be instantiated
3. `TailRiskScenario` dataclass - Cannot be instantiated
4. Monte Carlo simulation modules using these scenarios
5. Stress testing modules
6. Risk analytics that import risk_scenarios
7. Tests that use these scenario classes

**Severity**: S2 (High)
- Entire risk_scenarios module broken at import time
- Blocks Monte Carlo simulations
- Prevents stress testing functionality
- Breaks risk analytics features
- Tests cannot run due to import failure

## Diagnosis Timeline

### T0: Detection/Context (2025-10-11)
- Issue #106 opened: "Bug: risk_scenarios dataclasses break import due to non-default fields after defaults"
- Reported: `TypeError: non-default argument 'asset_returns' follows default argument`
- Occurs during pytest collection when importing risk_scenarios

### T1: Investigation (2025-10-13)
- Verified import failure in `risk_scenarios.py`
- Identified dataclass inheritance issue with `Scenario` base class
- Found 3 child classes with required fields after parent's optional field
- Confirmed violation of Python dataclass inheritance ordering rules

### T2: Scope Analysis (2025-10-13)
- Parent class `Scenario` has optional field `description: Optional[str] = None`
- Child classes affected:
  - ❌ `MacroeconomicScenario` - 6 required fields (asset_returns, gdp_shock, inflation_shock, interest_rate_shock, unemployment_change, credit_spread_change)
  - ❌ `StressScenario` - 4 required fields (asset_returns, systemic_risk_indicators, contagion_matrix, severity_score)
  - ❌ `TailRiskScenario` - 3 required fields (asset_returns, tail_probability, extreme_value_parameters, expected_shortfall)
- Correctly implemented:
  - ✅ `MarketScenario` - Uses `field(default_factory=...)` for all fields
  - ✅ `ReverseStressScenario` - All required fields, no optional parent field issue

### T3: Root Cause Identified (2025-10-13)
- **Root Cause**: Dataclass inheritance field ordering violation
- **Pattern**: Similar to issues #116 (GlobalExplanation) and #107 (OptimalExecutionParams), but this involves **inheritance** not just field ordering
- **Code Impact**: Entire risk_scenarios module cannot be imported
- **Test Impact**: All Monte Carlo, stress testing, and risk analytics tests fail at import time

## Root Cause Analysis

### 5 Whys

1. **Why does the risk_scenarios module fail to import?**
   - Because Python raises a TypeError when defining child dataclasses that inherit from `Scenario`

2. **Why does Python raise a TypeError?**
   - Because child classes (`MacroeconomicScenario`, `StressScenario`, `TailRiskScenario`) define required fields without defaults after inheriting from parent class `Scenario` which has optional field `description`

3. **Why do child classes have required fields after parent's optional field?**
   - Possible reasons:
     a) Developer didn't realize dataclass inheritance combines parent and child fields in order
     b) Semantic intent (required business logic fields) conflicted with Python syntax requirements
     c) `MarketScenario` shows the correct pattern (all fields with defaults) but wasn't followed
     d) No validation or linting to catch dataclass inheritance ordering violations

4. **Why wasn't this caught in code review?**
   - No automated linting for dataclass inheritance field ordering
   - Manual review may not have caught subtle inheritance ordering issue
   - Tests may not have been run after adding these child classes
   - Pattern of `MarketScenario` (correct) vs other scenarios (incorrect) not recognized

5. **Why wasn't this caught in CI?**
   - Tests likely not covering risk scenario imports
   - CI may not be running import validation across all modules
   - No static analysis checking dataclass inheritance field ordering
   - Risk scenarios may not be actively used in current test suite

### Causal Chain

**Feature Development** → **Base Scenario Class Created with Optional Field** → **Child Classes Added with Required Fields** → **Python Dataclass Inheritance Validation Fails** → **Import Error** → **Risk Scenarios Module Broken**

### Change-Based Analysis

The dataclass hierarchy was likely designed with semantic clarity in mind:
1. Base `Scenario` class with common fields (name, type, probability, time_horizon) + optional description
2. Specialized child classes with domain-specific required fields (macro shocks, stress indicators, tail metrics)

This logical structure makes sense semantically, but violates Python's syntactic requirement that in dataclass inheritance, all fields are combined in definition order, so no child class can add required fields after parent has optional fields.

**Correct Pattern Already Exists**: `MarketScenario` (lines 123-148) shows the solution - use `field(default_factory=...)` for all child class fields when parent has optional fields.

## Remediation

### Immediate Fix Options

**Option 1: Add defaults to all child class fields (Recommended)**
Use `field(default_factory=...)` for all fields in child classes, following the `MarketScenario` pattern:

```python
@dataclass
class MacroeconomicScenario(Scenario):
    """Macroeconomic scenario."""
    # All fields need defaults since parent class has optional field
    asset_returns: Dict[str, float] = field(default_factory=dict)
    gdp_shock: float = 0.0
    inflation_shock: float = 0.0
    interest_rate_shock: float = 0.0
    unemployment_change: float = 0.0
    credit_spread_change: float = 0.0
    term_spread_change: Optional[float] = None
    fx_changes: Optional[Dict[str, float]] = None
    sector_impacts: Optional[Dict[str, float]] = None
```

**Option 2: Remove optional field from parent (Alternative)**
Remove `description: Optional[str] = None` from base `Scenario` class:

```python
@dataclass
class Scenario:
    """Base class for all scenario types."""
    name: str
    scenario_type: ScenarioType
    probability: float
    time_horizon: float  # Years
    # REMOVED: description: Optional[str] = None
```

Then add it to each child class as needed.

**Option 3: Use kw_only (Python 3.10+)**
Use `kw_only=True` in parent class to allow mixing:

```python
@dataclass
class Scenario:
    name: str
    scenario_type: ScenarioType
    probability: float
    time_horizon: float
    description: Optional[str] = field(default=None, kw_only=True)
```

### Recommended Solution

**Use Option 1 (add defaults to child fields)** because:
1. Follows existing `MarketScenario` pattern (lines 123-148)
2. Preserves parent class API (no breaking changes)
3. Provides sensible defaults (empty dict for asset_returns, 0.0 for shocks)
4. Minimal changes to existing code structure
5. Clear intent: scenarios can be created with partial data and filled in later
6. Makes sense semantically: scenarios are often built incrementally

### Risk & Rollback Considerations

- **Risk**: Very Low - Adding defaults with sensible values
- **Breaking Changes**: None - fields remain with same types, just gain defaults
- **API Impact**: Constructor becomes more flexible (can omit parameters)
- **Rollback**: Revert commit if issues arise
- **Side Effects**: None - makes scenarios easier to construct
- **Testing**: Verify instantiation with and without parameters

## Validation & Prevention

### Test Plan
1. ✅ Identify child classes with required fields after parent's optional field
2. ⬜ Add defaults to all fields in `MacroeconomicScenario`
3. ⬜ Add defaults to all fields in `StressScenario`
4. ⬜ Add defaults to all fields in `TailRiskScenario`
5. ⬜ Verify import works: `python -c "from alpha_pulse.models.risk_scenarios import MacroeconomicScenario, StressScenario, TailRiskScenario"`
6. ⬜ Verify instantiation works with test data
7. ⬜ Verify instantiation works with minimal parameters (using defaults)
8. ⬜ Run full test suite to ensure no regressions

### Commands
```bash
# Test import after fix
PYTHONPATH=src poetry run python -c "from alpha_pulse.models.risk_scenarios import MacroeconomicScenario, StressScenario, TailRiskScenario; print('✅ Import successful')"

# Test instantiation with full parameters
PYTHONPATH=src poetry run python -c "
from alpha_pulse.models.risk_scenarios import MacroeconomicScenario, ScenarioType
from datetime import datetime
scenario = MacroeconomicScenario(
    name='Test Recession',
    scenario_type=ScenarioType.MACRO,
    probability=0.15,
    time_horizon=1.0,
    asset_returns={'AAPL': -0.20, 'MSFT': -0.15},
    gdp_shock=-0.03,
    inflation_shock=0.02,
    interest_rate_shock=0.01,
    unemployment_change=0.02,
    credit_spread_change=50.0
)
print('✅ Full instantiation successful')
print(f'Scenario: {scenario.name}, GDP shock: {scenario.gdp_shock}')
"

# Test instantiation with defaults
PYTHONPATH=src poetry run python -c "
from alpha_pulse.models.risk_scenarios import MacroeconomicScenario, ScenarioType
scenario = MacroeconomicScenario(
    name='Minimal Test',
    scenario_type=ScenarioType.MACRO,
    probability=0.10,
    time_horizon=0.5
)
print('✅ Minimal instantiation successful (using defaults)')
print(f'Scenario: {scenario.name}, GDP shock: {scenario.gdp_shock} (default)')
"
```

### Regression Prevention
- **Linting**: Add ruff or mypy checks for dataclass inheritance field ordering
- **Pre-commit Hook**: Validate dataclass inheritance patterns
- **CI Check**: Add import validation for all models modules
- **Code Review Checklist**: Include dataclass inheritance ordering check
- **Documentation**: Add Python dataclass inheritance best practices to coding standards
- **Pattern Library**: Document `MarketScenario` as the correct pattern for child dataclasses

## Conclusion

This is a **GENUINE BUG** - Python dataclass inheritance field ordering violation in 3 child classes.

**Impact:**
- ❌ `MacroeconomicScenario` class: Cannot be defined (import-time error)
- ❌ `StressScenario` class: Cannot be defined (import-time error)
- ❌ `TailRiskScenario` class: Cannot be defined (import-time error)
- ❌ Entire risk_scenarios module: Cannot be imported
- ❌ Monte Carlo simulations: Blocked
- ❌ Stress testing: Blocked
- ❌ Risk analytics tests: Cannot run

**Fix Required:**
Add defaults to all fields in child classes using `field(default_factory=...)` or scalar defaults, following the `MarketScenario` pattern.

**Affected Classes:**
- `MacroeconomicScenario` (lines 152-181): 6 required fields → need defaults
- `StressScenario` (lines 185-226): 4 required fields → need defaults
- `TailRiskScenario` (lines 230-252): 4 required fields → need defaults

**Pattern**: Same dataclass ordering issue as #116 (GlobalExplanation) and #107 (OptimalExecutionParams), but involves **inheritance** complexity.

## Ownership & Next Steps

- **Owner(s)**: Repository maintainers (blackms)
- **Priority**: High - Blocks risk scenario functionality
- **Dependencies/links**:
  - Issue #106: https://github.com/blackms/AlphaPulse/issues/106
  - Similar pattern to #116 (v1.21.2) and #107 (v1.21.3)
  - Correct pattern: `MarketScenario` (lines 123-148)
  - Files affected:
    - `src/alpha_pulse/models/risk_scenarios.py`

### Checklist
- [x] Reproducible steps verified (Import error confirmed)
- [x] Evidence attached/linked (Error trace, code analysis)
- [x] RCA written and reviewed (5 Whys, causal chain complete)
- [ ] Defaults added to MacroeconomicScenario fields
- [ ] Defaults added to StressScenario fields
- [ ] Defaults added to TailRiskScenario fields
- [ ] Import verified
- [ ] Tests passing
- [ ] Issue closed

---

**Generated**: 2025-10-13
**Analyzed by**: Claude Code (BUG-PROTO.yaml workflow)
**Status**: ANALYSIS COMPLETE - GENUINE DATACLASS INHERITANCE BUG (Add defaults to child fields)
