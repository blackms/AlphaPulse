# Bug Report — Issue #118 Misdiagnosed: AlertingSystem Import Not the Root Cause

## Summary
- **Scope/Area**: tests/risk_budgeting_service, models/risk_budget
- **Type**: Test Code Error — Severity: S3 (Medium)
- **Environment**:
  - Branch: main
  - Commit: 115c65ae8db2dc827003e144c2e70a9143417ce0
  - OS: Darwin 24.5.0
  - Python: 3.11-3.12

## Expected vs Actual
- **Expected**: Risk budgeting service tests pass successfully
- **Actual**: Tests fail with `AttributeError: type object 'RiskBudgetType' has no attribute 'DYNAMIC'`
- **Issue Report Claimed**: `ImportError: cannot import name 'AlertingSystem'` - This is INCORRECT

## Steps to Reproduce
1. `poetry run pytest src/alpha_pulse/tests/test_risk_budgeting_service.py`
2. Observe `AttributeError` in test fixture setup at line 127

## Evidence

### The Real Error
```python
# src/alpha_pulse/tests/test_risk_budgeting_service.py:127
primary_budget = RiskBudget(
    budget_id='budget-1',
    budget_type=RiskBudgetType.DYNAMIC,  # ❌ DYNAMIC doesn't exist!
                ^^^^^^^^^^^^^^^^^^^^^^
    ...
)

# Error:
AttributeError: type object 'RiskBudgetType' has no attribute 'DYNAMIC'
```

### AlertingSystem Import is NOT the Problem
The test already has a **working fallback** for AlertingSystem:

```python
# src/alpha_pulse/tests/test_risk_budgeting_service.py:27-30
try:
    from alpha_pulse.monitoring.alerting import AlertingSystem
except ImportError:  # Fallback for environments without legacy symbol
    AlertingSystem = MagicMock  # type: ignore
```

This handles the missing AlertingSystem gracefully using MagicMock.

### RiskBudgetType Enum Definition
From `/src/alpha_pulse/models/risk_budget.py:14-22`:

```python
class RiskBudgetType(Enum):
    """Types of risk budgets."""
    MARKET = "market"
    SPECIFIC = "specific"
    SECTOR = "sector"
    GEOGRAPHIC = "geographic"
    FACTOR = "factor"
    TAIL = "tail"
    TOTAL = "total"
    # ❌ NO 'DYNAMIC' attribute
```

### Test Fixture Error
```
____ ERROR at setup of TestRiskBudgetingService.test_service_initialization ____

src/alpha_pulse/tests/test_risk_budgeting_service.py:127: AttributeError
E       AttributeError: type object 'RiskBudgetType' has no attribute 'DYNAMIC'
```

## Diagnosis Timeline

### T0: Detection/Context (2025-10-11 17:41:28Z)
- Issue #118 opened claiming: "ImportError: cannot import name 'AlertingSystem'"
- Title: "AlertingSystem symbol removed from monitoring.alerting"
- **Diagnosis**: INCORRECT - This is not the actual error

### T1: Initial Investigation (2025-10-12)
- Checked `/src/alpha_pulse/monitoring/alerting/__init__.py`
- Confirmed: `AlertingSystem` is NOT exported (only `AlertManager`)
- **BUT**: Test has fallback handling for this!

### T2: Actual Error Discovery (2025-10-12)
- Ran test: `poetry run pytest src/alpha_pulse/tests/test_risk_budgeting_service.py`
- **Real Error**: `AttributeError: type object 'RiskBudgetType' has no attribute 'DYNAMIC'`
- Location: Line 127 in test fixture setup
- The test never gets to the AlertingSystem code because it fails earlier

### T3: Root Cause Identified (2025-10-12)
- **Root Cause**: Test uses `RiskBudgetType.DYNAMIC` which doesn't exist in the enum
- **Valid values**: MARKET, SPECIFIC, SECTOR, GEOGRAPHIC, FACTOR, TAIL, TOTAL
- **Fix needed**: Change test to use a valid RiskBudgetType value

## Root Cause Analysis

### 5 Whys

1. **Why did the tests fail?**
   - Because the test fixture tries to create a RiskBudget with `RiskBudgetType.DYNAMIC`

2. **Why does RiskBudgetType.DYNAMIC fail?**
   - Because the `RiskBudgetType` enum doesn't have a `DYNAMIC` attribute

3. **Why was DYNAMIC used in the test?**
   - Likely the enum was refactored and DYNAMIC was removed, but the test wasn't updated
   - Or the test was written with an incorrect assumption about available enum values

4. **Why did the issue report claim the error was about AlertingSystem?**
   - Misdiagnosis - the issue reporter may have:
     a) Looked at the imports and assumed the AlertingSystem import was the problem
     b) Not run the actual test to see the real error
     c) Reported based on static analysis rather than runtime behavior

5. **Why wasn't this caught earlier?**
   - Tests may not be running in CI consistently
   - The refactoring that removed DYNAMIC didn't update all test references
   - No validation of enum usage in tests

### Causal Chain

**Enum Refactored/Defined** → **DYNAMIC Not Included** → **Test Still References DYNAMIC** → **Test Fixture Fails at Setup** → **AttributeError Raised** → **Issue Misdiagnosed as AlertingSystem Import Problem**

### Change-Based Analysis

Checking for changes to RiskBudgetType or risk budget models would reveal when DYNAMIC was removed or why it was never added. The enum clearly defines only 7 types (MARKET, SPECIFIC, SECTOR, GEOGRAPHIC, FACTOR, TAIL, TOTAL), and "DYNAMIC" is not among them.

## Remediation

### Immediate Fix

**Option 1: Use existing enum value**
Change line 127 in test from:
```python
budget_type=RiskBudgetType.DYNAMIC,
```
to:
```python
budget_type=RiskBudgetType.TOTAL,
```

**Option 2: Add DYNAMIC to the enum (if it's a valid concept)**
If "DYNAMIC" is actually a valid budget type that was accidentally omitted:
```python
class RiskBudgetType(Enum):
    """Types of risk budgets."""
    MARKET = "market"
    SPECIFIC = "specific"
    SECTOR = "sector"
    GEOGRAPHIC = "geographic"
    FACTOR = "factor"
    TAIL = "tail"
    TOTAL = "total"
    DYNAMIC = "dynamic"  # Add if conceptually valid
```

### Recommended Solution

Based on the enum definition and test context, **Option 1** is recommended. Change the test to use `RiskBudgetType.TOTAL` which appears to be the appropriate type for a general risk budget.

### Risk & Rollback Considerations

- **Risk**: Very Low - Simple test fix, no production code impact
- **Rollback**: Not needed - This is a test-only change
- **Impact**: Fixes failing tests, unblocks other test suites

## Validation & Prevention

### Test Plan
1. ✅ Identify all uses of `RiskBudgetType.DYNAMIC` in codebase
2. ⬜ Replace with valid enum value (likely TOTAL)
3. ⬜ Run full test suite to verify fix
4. ⬜ Check for other enum misusages in tests

### Validation Commands
```bash
# Search for all uses of DYNAMIC
grep -r "RiskBudgetType.DYNAMIC" src/

# Run the specific test
poetry run pytest src/alpha_pulse/tests/test_risk_budgeting_service.py -v

# Run all risk-related tests
poetry run pytest src/alpha_pulse/tests/test_risk* -v
```

### Regression Prevention
- Add enum validation in test fixtures
- Use `pytest.mark.parametrize` with valid enum values
- Add pre-commit hook to validate enum usage
- CI should fail on AttributeError (already does)

### Monitoring/Alerts
- Ensure CI runs full test suite on every commit
- Add static analysis to catch undefined enum attributes
- Document valid enum values in test documentation

## Conclusion

**This issue is MISDIAGNOSED**. The actual error is:
- ❌ **NOT**: `ImportError: cannot import name 'AlertingSystem'`
- ✅ **ACTUAL**: `AttributeError: type object 'RiskBudgetType' has no attribute 'DYNAMIC'`

The AlertingSystem import issue exists but is already handled with a try/except fallback. The test never reaches that code because it fails earlier when trying to use the non-existent `RiskBudgetType.DYNAMIC`.

### Corrected Issue Details
- **Title**: Bug: test_risk_budgeting_service uses non-existent RiskBudgetType.DYNAMIC
- **Type**: Test Code Error
- **Severity**: S3 (Medium) - Breaks tests but not production code
- **Fix**: Change `RiskBudgetType.DYNAMIC` to `RiskBudgetType.TOTAL` in test fixture

## Ownership & Next Steps

- **Owner(s)**: Repository maintainers (blackms)
- **Priority**: Medium - Blocks test execution
- **Dependencies/links**:
  - Issue #118: https://github.com/blackms/AlphaPulse/issues/118 (misdiagnosed)
  - File: `/src/alpha_pulse/tests/test_risk_budgeting_service.py:127`
  - Enum: `/src/alpha_pulse/models/risk_budget.py:14`

### Checklist
- [x] Reproducible steps verified (Error reproduced)
- [x] Evidence attached/linked (Full stack trace and enum definition)
- [x] RCA written and reviewed (5 Whys, causal chain complete)
- [ ] Fix implemented (Change DYNAMIC to TOTAL)
- [ ] Tests passing
- [ ] Issue updated with correct diagnosis

---

**Generated**: 2025-10-12
**Analyzed by**: Claude Code (BUG-PROTO.yaml workflow)
**Status**: ANALYSIS COMPLETE - ISSUE MISDIAGNOSED (Real cause: Undefined enum value)
